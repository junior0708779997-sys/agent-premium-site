<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connexion - AGENT PREMIUM</title>
  <meta name="description" content="Connectez-vous pour conserver votre historique de commandes et d'achats.">
  <link rel="stylesheet" href="style.css?v=20260218-7">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <main class="conditions" style="max-width:520px;margin:40px auto;">
    <h1>Connexion client</h1>
    <p>Connectez-vous pour conserver votre historique de commandes.</p>

    <div class="auth-tabs">
      <button id="tab-login" class="auth-tab active" type="button">Connexion</button>
      <button id="tab-register" class="auth-tab" type="button">Creer un compte</button>
    </div>

    <form id="login-form" class="auth-card">
      <input type="email" id="login-email" placeholder="Email" required>
      <input type="password" id="login-password" placeholder="Mot de passe" required>
      <label id="human-check-label" style="font-size:13px;color:#31527f;">Verification: --</label>
      <input type="number" id="human-check-input" placeholder="Reponse anti-bot" required>
      <button type="submit">Se connecter</button>
      <button type="button" id="reset-password-btn" style="background:#eef5ff;color:#1f3559;border:1px solid #d3deef;">Mot de passe oublie</button>
    </form>

    <form id="register-form" class="auth-card" style="display:none;">
      <input type="text" id="register-name" placeholder="Nom complet" required>
      <input type="email" id="register-email" placeholder="Email" required>
      <input type="password" id="register-password" placeholder="Mot de passe" required>
      <button type="submit">Creer mon compte</button>
    </form>

    <div class="auth-separator" id="auth-separator">ou</div>
    <div id="google-login-wrap" style="display:flex;justify-content:center;"></div>
    <p id="auth-message" style="margin-top:12px;font-size:14px;"></p>
    <p style="margin-top:14px;"><a href="index.html">Retour a l'accueil</a></p>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="backend-config.js?v=20260218-7"></script>
  <script src="backend.js?v=20260218-7"></script>
  <script src="auth-config.js?v=20260218-7"></script>
  <script src="auth.js?v=20260218-7"></script>
  <script>
    const redirectTo = new URLSearchParams(window.location.search).get("redirect") || "index.html";
    const messageEl = document.getElementById("auth-message");
    const resetBtn = document.getElementById("reset-password-btn");
    const loginForm = document.getElementById("login-form");
    const registerForm = document.getElementById("register-form");
    const tabLogin = document.getElementById("tab-login");
    const tabRegister = document.getElementById("tab-register");
    const humanLabel = document.getElementById("human-check-label");
    const humanInput = document.getElementById("human-check-input");
    let humanA = 0;
    let humanB = 0;

    function refreshHumanCheck() {
      humanA = Math.floor(Math.random() * 7) + 2;
      humanB = Math.floor(Math.random() * 7) + 2;
      humanLabel.textContent = `Verification: ${humanA} + ${humanB} = ?`;
      if (humanInput) humanInput.value = "";
    }

    function setMessage(text, ok = false) {
      messageEl.textContent = text;
      messageEl.style.color = ok ? "#0b7f66" : "#9a2d2d";
    }

    function showLogin() {
      loginForm.style.display = "";
      registerForm.style.display = "none";
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      setMessage("");
    }

    function showRegister() {
      loginForm.style.display = "none";
      registerForm.style.display = "";
      tabRegister.classList.add("active");
      tabLogin.classList.remove("active");
      setMessage("");
    }

    tabLogin.addEventListener("click", showLogin);
    tabRegister.addEventListener("click", showRegister);

    function lockKey(email) {
      return "ap_login_lock_" + String(email || "").toLowerCase();
    }

    function getLockInfo(email) {
      try { return JSON.parse(localStorage.getItem(lockKey(email))) || { fails: 0, until: 0 }; }
      catch { return { fails: 0, until: 0 }; }
    }

    function setLockInfo(email, info) {
      localStorage.setItem(lockKey(email), JSON.stringify(info));
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;
      const humanValue = parseInt(humanInput.value, 10) || 0;
      if (humanValue !== (humanA + humanB)) {
        setMessage("Verification anti-bot incorrecte.");
        refreshHumanCheck();
        return;
      }
      const lock = getLockInfo(email);
      if (lock.until && Date.now() < lock.until) {
        const remain = Math.ceil((lock.until - Date.now()) / 1000);
        setMessage(`Trop de tentatives. Reessayez dans ${remain}s.`);
        return;
      }
      const result = await window.AgentAuth.loginEmail(email, password);
      if (!result.ok) {
        const next = getLockInfo(email);
        next.fails = (next.fails || 0) + 1;
        if (next.fails >= 5) {
          next.until = Date.now() + (10 * 60 * 1000);
          next.fails = 0;
        }
        setLockInfo(email, next);
        setMessage(result.message);
        refreshHumanCheck();
        return;
      }
      setLockInfo(email, { fails: 0, until: 0 });
      setMessage("Connexion reussie, redirection...", true);
      setTimeout(() => window.location.href = redirectTo, 500);
    });

    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("register-name").value.trim();
      const email = document.getElementById("register-email").value.trim();
      const password = document.getElementById("register-password").value;
      const result = await window.AgentAuth.registerEmail(name, email, password);
      if (!result.ok) {
        setMessage(result.message);
        return;
      }
      setMessage("Compte cree avec succes, redirection...", true);
      setTimeout(() => window.location.href = redirectTo, 500);
    });

    const googleEnabled = window.AgentAuth.initGoogleButton(
      "google-login-wrap",
      () => {
        setMessage("Connexion Google reussie, redirection...", true);
        setTimeout(() => window.location.href = redirectTo, 500);
      },
      (error) => setMessage(error || "Echec connexion Google.")
    );
    if (!googleEnabled) {
      const sep = document.getElementById("auth-separator");
      const googleWrap = document.getElementById("google-login-wrap");
      if (sep) sep.style.display = "none";
      if (googleWrap) googleWrap.style.display = "none";
    }

    if (window.AgentAuth.getCurrentUser()) {
      window.location.href = redirectTo;
    }
    refreshHumanCheck();

    resetBtn.addEventListener("click", async () => {
      const email = prompt("Entrez votre email:");
      if (!email) return;
      const newPwd = prompt("Entrez votre nouveau mot de passe:");
      if (!newPwd) return;
      const result = await window.AgentAuth.resetPasswordEmail(email, newPwd);
      if (!result.ok) {
        setMessage(result.message);
        return;
      }
      setMessage("Mot de passe mis a jour. Vous pouvez vous connecter.", true);
    });
  </script>
</body>
</html>
